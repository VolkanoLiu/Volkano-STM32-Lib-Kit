# Volkano-STM32-Lib-Kit

## 一、介绍

Volkano-STM32-Lib-Kit是[作者](https://github.com/VolkanoLiu)在学习STM32 HAL库过程中所写的OLED、任务管理、按键处理的一些代码，没有精致的代码（但后期会维护），bug维护也会很缓慢（因为很摸），而且注释不全（后期会补），但是欢迎各位来友好讨论（肛道理）。

## 二、具体模块

#### 1. OLED/ASCII

本库通过两种方式驱动，使用宏**OLED_USE_DMA**来决定使用哪种方式；ASCII库中只有8*6的字库，可以显示8行21列字符（因为很好实现）。

##### (1) 传统硬件SPI控制OLED

传统的SPI方式仅仅只能将指令与数据传输到显示屏，无法得知当前的屏幕显示状态（但是可以实现），需要CPU的调度，但每次发送的指令很少，所以只会消耗较少的资源，主要来实现字符的显示，绘画比较麻烦。

##### (2) 通过DMA将GRAM中的数据通过SPI定时发送到屏幕

此方式在单片机中开辟了一块专门的显存，将flushScreen函数添加到任务管理中来实现定时刷新，但由于其有**HAL_Delay**函数，故不能将其添加到中断中，否则会造成硬件的死机。

#### 2. taskmanage

任务管理分别将任务分为前台任务与后台任务，前台任务管理被置于中断处理函数中，后台管理则在while(1)中循环，前台与后台任务分别有如下特点：

| 任务类型 | 任务特点                                                     |
| -------- | ------------------------------------------------------------ |
| 前台任务 | 前台任务的主要特点是耗费时间短（ns至μs级别），不能有Delay相关的函数，运行精度较高。 |
| 后台任务 | 后台任务是需要耗费较长时间的任务，执行期间可能会被前台任务打断。 |

同时，你也可以自己在taskmanager中自己立flag来执行特定的函数（比如示例中按下按钮来清空显存并将字符串缓冲区里的字符刷新至显示屏上就是自定义flag任务）。

> *任务管理的灵感来源自Tang_JY*

#### 3. keypress_process/matrix_key

按键处理就是定时扫描并确定GPIO的状态，并调用相应的函数。（代码即将完善）

#### 4. mem_sync

以各种协议（目前只做了SPI）和另外一个设备进行通信，定时同步内存。

## 三、使用方法

#### 1. 显示屏控制相关

| 名称            | 类型（默认函数） | 说明                                                      |
| --------------- | ---------------- | --------------------------------------------------------- |
| char_pos        | typedef struct   | 表明下一个字符的相对坐标（0-21列，0-7行），与像素坐标不同 |
| GRAM            | uint8_t[128*8]   | 显存                                                      |
| SetSPIHandle    |                  | 设置SPI句柄                                               |
| Set_DC_GPIO     |                  |                                                           |
| Set_RS_GPIO     |                  |                                                           |
| SH1106_Init     |                  | 初始化OLED                                                |
| drawPixel//todo |                  |                                                           |
| setCharCursor   |                  | 设置字符光标的位置                                        |
| drawChar        |                  | 显示一个字符，并将字符坐标移至下一位                      |
| drawString      |                  | 从字符坐标位置显示一个字符串                              |
| flushScreen     |                  | 刷新屏幕（可以将其添加到任务管理中）                      |
| clearScreen     |                  | 清屏                                                      |



#### 2. 任务管理相关

| 名称                  | 类型 | 说明                               |
| --------------------- | ---- | ---------------------------------- |
| taskElement_Typedef   |      | 任务事件类型定义                   |
| taskList_Typedef      |      | 任务队列类型定义                   |
| taskListInit          |      | 初始化任务队列                     |
| foregroundTaskInit    |      | 初始化前台任务，并将其添加到队列中 |
| backgroundTaskInit    |      | 初始化后台任务，并将其添加到队列中 |
| taskSetConfig         |      | 设置任务的配置                     |
| addTask               |      |                                    |
| foregroundTaskManager |      | 前台任务管理程序                   |
| backgroundTaskManager |      | 后台任务管理程序                   |



#### 3. 按键处理相关

| 名称             | 类型 | 说明                                             |
| ---------------- | ---- | ------------------------------------------------ |
| FSMKey_Typedef   | ...  | 按键类型定义                                     |
| KeyGroup_Typedef | ...  | 按键组类型定义                                   |
| keyInit          |      | 初始化按键                                       |
| keyGroupInit     |      | 初始化按键组                                     |
| keyFlushBuffer   |      | 刷新按键缓存（每一个周期对GPIO采样一次，并刷新） |
| keyScan          |      | 更新按键状态，并执行相应的函数                   |
| keyScanAll       |      | 更新按键组状态                                   |



#### 4. 内存同步相关

有很严重的bug，暂时未修复

| 名称            | 类型 | 说明                                           |
| --------------- | ---- | ---------------------------------------------- |
| memSyncTaskInit |      | 初始化内存同步的任务                           |
| sync_mem_TX     |      | 发送内存信息，需要将其加到任务管理中           |
| sync_mem_RX     |      | 接收内存信息，需要将其加到外部中断的回调函数中 |



## 四、注意事项

- 单片机的相关配置在.ioc文件中，可以自行修改
- 重新生成代码后，一定要将Src/main.c中SPI和DMA的初始化函数交换位置，否则DMA功能将不工作
- 命名规范、代码规范和注释规范会在后面的学习中逐步完成

## 五、License

（待定）